<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link href='https://fonts.googleapis.com/css?family=Chivo:900' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/pygment_trac.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <title>Goose by gotsunami</title>
  </head>

  <body>
    <div id="container">
      <div class="inner">

        <header>
          <h1>Goose</h1>
          <h2>A Go library for Elasticsearch</h2>
        </header>

        <section id="downloads" class="clearfix">
          <a href="https://github.com/gotsunami/goose/zipball/master" id="download-zip" class="button"><span>Download .zip</span></a>
          <a href="https://github.com/gotsunami/goose/tarball/master" id="download-tar-gz" class="button"><span>Download .tar.gz</span></a>
          <a href="https://github.com/gotsunami/goose" id="view-on-github" class="button"><span>View on GitHub</span></a>
        </section>

        <hr>

        <section id="main_content">
          <p><img src="http://go-tsunami.com/assets/images/gooseLogo.png" alt="logo"></p>

<h1>
<a id="goose-a-golang-api-for-elastic-search" class="anchor" href="#goose-a-golang-api-for-elastic-search" aria-hidden="true"><span class="octicon octicon-link"></span></a>goose, a golang API for Elastic Search</h1>

<p>goose is an attempt to write a library to easily use the power of elastic search within a golang program.
The coverage of elastic functionalities is currently quite low but allows one to use the basics:</p>

<ul>
<li>CRUD operations on indexes</li>
<li>Add mapping</li>
<li>Search</li>
<li>Sort</li>
</ul>

<p>It takes advantages of golang interface concept to offer flexibility. A really cool feature is the <code>QueryBuilder</code>!</p>

<h2>
<a id="requirements" class="anchor" href="#requirements" aria-hidden="true"><span class="octicon octicon-link"></span></a>Requirements</h2>

<p>goose requires what it exists for: golang and elastic search.
The current version of goose works with golang 1.3 and elastic search 1.x</p>

<h2>
<a id="installation" class="anchor" href="#installation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Installation</h2>

<p>Use <code>go get</code>:</p>

<div class="highlight highlight-go"><pre><span class="pl-k">go</span> get github.<span class="pl-v">com</span>/gotsunami/goose</pre></div>

<h2>
<a id="powerful-query-builders" class="anchor" href="#powerful-query-builders" aria-hidden="true"><span class="octicon octicon-link"></span></a>Powerful query builders!</h2>

<p>ES formalism is powerful but quite uneasy to learn or to write as it is not very human readable.</p>

<p>The idea of query builder is to create the ES requests without having to actually write the json content of the request. In addition, some request need PUSH, other need PUT or DELETE, query builders know which one to use.</p>

<p>There are two kinds of builders in goose right now detailed in the following sections:</p>

<ul>
<li>Mapping builders</li>
<li>Search builders</li>
</ul>

<h2>
<a id="elasticsearch" class="anchor" href="#elasticsearch" aria-hidden="true"><span class="octicon octicon-link"></span></a>ElasticSearch</h2>

<p>As suggested in elastic search documentation, one should open only one instance of a client to communicate with the elastic search server. In goose, this client is the type <code>ElasticSearch</code>. It will do most of the job.</p>

<p>In goose, an instance corresponds to an index so when you create an <code>ElasticSearch</code>, you must specify the index. You can create an instance as a global variable like that:</p>

<div class="highlight highlight-go"><pre><span class="pl-v">u</span>, <span class="pl-v">err</span> <span class="pl-ko">:=</span> url.<span class="pl-sf">Parse</span>(<span class="pl-s1"><span class="pl-pds">"</span>http://localhost:9200/my_index/<span class="pl-pds">"</span></span>)
<span class="pl-v">es</span>, <span class="pl-v">err</span> <span class="pl-ko">:=</span> goose.<span class="pl-sf">NewElasticSearch</span>(u)</pre></div>

<p>Note: each time <code>es</code> appears in the following document, it refers to the global instance of <code>ElasticSearch</code></p>

<h2>
<a id="elasticobject" class="anchor" href="#elasticobject" aria-hidden="true"><span class="octicon octicon-link"></span></a>ElasticObject</h2>

<p>goose also uses an interface called <code>ElasticObject</code> for most API calls.
This interface must define a function called <code>Key()</code> that can compute an unique key for each instance.
Once your data structure implements <code>ElasticObject</code>, you are almost done! (well, almost I said...)</p>

<p>For instance:</p>

<div class="highlight highlight-go"><pre><span class="pl-k">type</span> <span class="pl-v">HQ</span> <span class="pl-s">struct</span> {
    <span class="pl-v">Company</span>  <span class="pl-s">string</span> <span class="pl-s1"><span class="pl-pds">`</span>json:"company"<span class="pl-pds">`</span></span>
    <span class="pl-v">Country</span>  <span class="pl-s">uint64</span> <span class="pl-s1"><span class="pl-pds">`</span>json:"country"<span class="pl-pds">`</span></span>
    <span class="pl-v">Location</span> goose.<span class="pl-v">Location</span> <span class="pl-s1"><span class="pl-pds">`</span>json:"location"<span class="pl-pds">`</span></span>
}

<span class="pl-k">func</span> <span class="pl-enfgf">(<span class="pl-v">hq</span> *<span class="pl-v">HQ</span>) <span class="pl-enf">Key</span></span>() <span class="pl-v">string</span> {
    <span class="pl-k">return</span> fmt.<span class="pl-sf">Sprintf</span>(<span class="pl-s1"><span class="pl-pds">"</span><span class="pl-c1">%s</span>_<span class="pl-c1">%d</span><span class="pl-pds">"</span></span>, hq.<span class="pl-v">Company</span>, hq.<span class="pl-v">Country</span>)
}</pre></div>

<h2>
<a id="indexes" class="anchor" href="#indexes" aria-hidden="true"><span class="octicon octicon-link"></span></a>Indexes</h2>

<p>First things first, basic index operations. As a <code>ElasicSearch</code> instance matches an unique index, it is pretty straightforward:</p>

<div class="highlight highlight-go"><pre><span class="pl-v">err</span> <span class="pl-ko">:=</span> es.<span class="pl-sf">CreateIndex</span>()
err = es.<span class="pl-sf">CreateIndexIfNeeded</span>()
err = es.<span class="pl-sf">OpenIndex</span>()
err = es.<span class="pl-sf">CloseIndex</span>()
err = es.<span class="pl-sf">DeleteIndex</span>()</pre></div>

<p>Refer to elastic search documentation to know more about indexes: <a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/indices.html">http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/indices.html</a></p>

<h2>
<a id="crud" class="anchor" href="#crud" aria-hidden="true"><span class="octicon octicon-link"></span></a>CRUD</h2>

<p>The <code>ElasticSearch</code> provides a set of functions for CRUD operations:</p>

<div class="highlight highlight-go"><pre><span class="pl-v">hq</span> <span class="pl-ko">:=</span> &amp;HQ{Company:<span class="pl-s1"><span class="pl-pds">"</span>go-tsunami<span class="pl-pds">"</span></span>, <span class="pl-v">Country</span>:<span class="pl-cn">33</span>, <span class="pl-v">Location</span>:goose.<span class="pl-v">Location</span>{<span class="pl-cn">48.865618</span>, <span class="pl-cn">2.370985</span>}}
<span class="pl-v">err</span> <span class="pl-ko">:=</span> es.<span class="pl-sf">Insert</span>(hq)
<span class="pl-v">found</span>, <span class="pl-v">err</span> <span class="pl-ko">:=</span> es.<span class="pl-sf">Get</span>(hq)
hq.<span class="pl-v">Company</span> = <span class="pl-s1"><span class="pl-pds">"</span>Go Tsunami<span class="pl-pds">"</span></span>
err = es.<span class="pl-sf">Update</span>(hq)
err = es.<span class="pl-sf">Delete</span>(hq)</pre></div>

<p>An additional  <code>DeleteByQuery</code> is available to delete a set of objects.</p>

<p>TODO: <code>UpdateByQuery</code></p>

<p>Refer to elastic search documentation for more information or to contribute: <a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/docs.html#docs">http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/docs.html#docs</a></p>

<h2>
<a id="mapping" class="anchor" href="#mapping" aria-hidden="true"><span class="octicon octicon-link"></span></a>Mapping</h2>

<p>Currently handled mapping types are:</p>

<ul>
<li>date</li>
<li>geo_point</li>
<li>string</li>
<li>long</li>
</ul>

<p>Here is an exemple of how to use a <code>MappingBuilder</code> to add a <code>geo_point</code> mapping to field Location of type HQ:</p>

<div class="highlight highlight-go"><pre><span class="pl-v">mb</span> <span class="pl-ko">:=</span> <span class="pl-sf">NewMappingBuilder</span>().<span class="pl-sf">AddMapping</span>(<span class="pl-s1"><span class="pl-pds">"</span>location<span class="pl-pds">"</span></span>, <span class="pl-v">TYPE_GEOPOINT</span>)
<span class="pl-v">err</span> <span class="pl-ko">:=</span> es.<span class="pl-sf">SetMapping</span>(&amp;HQ{}, mb)</pre></div>

<p>References:
<a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/indices-put-mapping.html">http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/indices-put-mapping.html</a></p>

<h2>
<a id="search" class="anchor" href="#search" aria-hidden="true"><span class="octicon octicon-link"></span></a>Search</h2>

<p>At last, here we are, ready to make search queries!</p>

<p>The query builder currently handles the following search criteria:</p>

<ul>
<li>geo_distance</li>
<li>geo_boundingbox</li>
<li>geo_polygon</li>
<li>should</li>
<li>must</li>
<li>facetting</li>
<li>fuzzy search</li>
<li>range</li>
<li>greater or lower than</li>
</ul>

<p>Here is an example:</p>

<div class="highlight highlight-go"><pre>qb = qb.<span class="pl-sf">SetTerm</span>(<span class="pl-s1"><span class="pl-pds">"</span>Company<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>Go Tsunami<span class="pl-pds">"</span></span>)
qb = qb.<span class="pl-sf">AddGeoBoundingBox</span>(<span class="pl-s1"><span class="pl-pds">"</span>location<span class="pl-pds">"</span></span>,
    goose.<span class="pl-v">Location</span>{-<span class="pl-cn">180</span>, <span class="pl-cn">90</span>},
    goose.<span class="pl-v">Location</span>{<span class="pl-cn">180</span>, -<span class="pl-cn">90</span>})

<span class="pl-v">total</span>, <span class="pl-v">err</span> <span class="pl-ko">:=</span> es.<span class="pl-sf">Count</span>(&amp;HQ{})
<span class="pl-k">if</span> err != <span class="pl-c1">nil</span> {
    <span class="pl-k">return</span> <span class="pl-c1">nil</span>, err
}

qb.<span class="pl-v">Size</span> = total
<span class="pl-v">results</span>, <span class="pl-v">err</span> <span class="pl-ko">:=</span> es.<span class="pl-sf">Search</span>(&amp;HQ{}, qb)
<span class="pl-k">if</span> err != <span class="pl-c1">nil</span> {
    <span class="pl-k">return</span> <span class="pl-c1">nil</span>, err
}

<span class="pl-k">for</span> <span class="pl-v">_</span>, <span class="pl-v">match</span> <span class="pl-ko">:=</span> <span class="pl-k">range</span> results.<span class="pl-v">Hits</span>.<span class="pl-v">Data</span> {
    <span class="pl-v">hq</span>, <span class="pl-v">ok</span> <span class="pl-ko">:=</span> match.<span class="pl-v">Object</span>.(*HQ)
    <span class="pl-k">if</span> !ok {
        <span class="pl-k">return</span> ids, errors.<span class="pl-sf">New</span>(
            fmt.<span class="pl-sf">Sprintf</span>(<span class="pl-s1"><span class="pl-pds">"</span>ElasticSearch returned an invalid object (<span class="pl-c1">%v</span>)<span class="pl-pds">"</span></span>, match.<span class="pl-v">Src</span>))
    }
    fmt.<span class="pl-sf">Println</span>(<span class="pl-s1"><span class="pl-pds">"</span>An HQ was found for Go Tsunami at GPS coordinates <span class="pl-c1">%v</span><span class="pl-pds">"</span></span>, hq.<span class="pl-v">Location</span>)
}</pre></div>

<h2>
<a id="more" class="anchor" href="#more" aria-hidden="true"><span class="octicon octicon-link"></span></a>More</h2>

<p>Source code contains a lot of comments, especially in the query builder. You can find a full example of a dumb application in example/hq.go.</p>

<p>You can play with it:</p>

<div class="highlight highlight-go"><pre><span class="pl-k">go</span> build example/hq.<span class="pl-v">go</span>
./hq</pre></div>

<p>If you want to run queries on the created index, you can find it at <code>http://localhost:9200/hq/main__hq</code></p>

<h2>
<a id="contribute" class="anchor" href="#contribute" aria-hidden="true"><span class="octicon octicon-link"></span></a>Contribute</h2>

<p>goose is an ongoing work, we'd be pleased to review any pull request!  </p>
        </section>

        <footer>
          Goose is maintained by <a href="https://github.com/gotsunami">gotsunami</a><br>
          This page was generated by <a href="http://pages.github.com">GitHub Pages</a>. Tactile theme by <a href="https://twitter.com/jasonlong">Jason Long</a>.
        </footer>

        
      </div>
    </div>
  </body>
</html>